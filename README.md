# Tampermonkey Editors

Online editor support for Tampermonkey's userscripts with both **Web Editor (vscode.dev)** and **Desktop Editor (VS Code)** support.

## ✨ New Features

- 🌐 **Web Editor**: Edit scripts in VS Code for the Web (vscode.dev)
- 💻 **Desktop Editor**: Edit scripts in VS Code Desktop application
- ⚙️ **User Preference**: Choose your preferred editor in the Options page
- 🔄 **Easy Switching**: Change between editors anytime via extension options

## 🚀 Quick Start (Recommended)

### Fully Automated Setup (3 Easy Scripts!)

We've automated ALL the manual steps from the original README:

```bash
# 1. Build everything (builds both Chrome & Firefox extensions)
./scripts/quick-build.sh

# 2. Validate the builds (ensures no CSP violations or cross-browser issues)
./scripts/validate-build.sh

# 3. Setup Tampermonkey for testing
./scripts/dev-setup.sh
```

**What gets automated:**
- ✅ Building proper Chrome extension (no Firefox code)
- ✅ Building proper Firefox extension (no Chrome code)
- ✅ Downloading Tampermonkey CRX
- ✅ Extracting Tampermonkey
- ✅ Modifying Tampermonkey's `background.js` with correct extension ID
- ✅ Validating builds (detects CSP violations, wrong APIs, etc.)
- ✅ Clear step-by-step instructions for manual parts

**What's still manual (requires browser interaction):**
- Loading extensions in Chrome/Firefox (can't be automated)
- Copying the actual Tampermonkey extension ID (generated by browser)
- Pasting config code in console

### Configuration Helper

After loading both extensions, use our helper to generate the config code:

```bash
./scripts/configure-tampermonkey.sh
```

This interactive script:
1. Asks for your Tampermonkey extension ID
2. Generates the exact configuration code
3. Saves it to `config-tampermonkey.js` for easy copying
4. Shows you where to paste it

---

## ⚡ Quick Build & Test Workflow

```bash
# Build and validate
./scripts/quick-build.sh && ./scripts/validate-build.sh

# Setup test environment  
./scripts/dev-setup.sh

# Generate config code
./scripts/configure-tampermonkey.sh

# Load extensions in browser and paste the config code
# Done! 🎉
```

---

## 📖 Manual Setup (Alternative)

### Step 1: Build the Extension

**Prerequisites:**
- Node.js 18.x ([download here](https://nodejs.org/))
- npm 8.0.0 or higher

**Build commands:**

```bash
# Install dependencies
npm install

# Build the extension
./build_sys/mkrelease.sh -v 999
```

The extension packages will be created in `./release/` folder:
- `tampermonkey_editors_999.chrome_mv3/` - For Chrome/Edge
- `tampermonkey_editors_999.firefox_mv3/` - For Firefox

### Step 2: Prepare Test Tampermonkey

```bash
mkdir -p other/tampermonkey
cd other/tampermonkey
wget https://www.tampermonkey.net/crx/tampermonkey_stable.crx
unzip tampermonkey_stable.crx

# For macOS:
sed -i '' 's/"hohmicmmlneppdcbkhepamlgfdokipcd"/"kjmbknaomholdmpocgplbkgmjdnidinh"/g' background.js

# For Linux:
sed -i 's/"hohmicmmlneppdcbkhepamlgfdokipcd"/"kjmbknaomholdmpocgplbkgmjdnidinh"/g' background.js
```

### Step 3A: Load in Chrome/Edge

1. **Open Extensions Page**
   - Navigate to `chrome://extensions/`
   - Enable "Developer mode" (toggle in top-right corner)

2. **Load Test Tampermonkey**
   - Click "Load unpacked"
   - Select folder: `./other/tampermonkey`
   - **Copy the extension ID** (e.g., `iomhjoeebbnlcpalefgjmleebfffgbmm`)

3. **Load Tampermonkey Editors**
   - Click "Load unpacked" again
   - Select folder: `./release/tampermonkey_editors_999.chrome_mv3`

4. **Configure Connection**
   - Find "Tampermonkey Editors" in the extensions list
   - Click "Inspect views: service worker" (opens DevTools console)
   - Paste this code (replace `YOUR_TM_ID` with the ID you copied):

   ```javascript
   chrome.storage.local.set({ 'config': { externalExtensionIds: [ 'YOUR_TM_ID' ] } })
   .then(() => {
       chrome.runtime.reload()
   });
   ```

5. **Test It**
   - Install a test userscript in Tampermonkey
   - Click the Tampermonkey Editors icon in the toolbar
   - Your chosen editor should open!

### Step 3B: Load in Firefox

1. **Open Debugging Page**
   - Navigate to `about:debugging#/runtime/this-firefox`

2. **Load Tampermonkey Editors**
   - Click "Load Temporary Add-on"
   - Navigate to and select: `./release/tampermonkey_editors_999.firefox_mv3/manifest.json`

3. **Install Tampermonkey**
   - Install from [Firefox Add-ons](https://addons.mozilla.org/firefox/addon/tampermonkey/)
   - OR use unpacked version (same as Chrome steps above)

4. **Configure Connection**
   - Similar to Chrome, configure the extension IDs in the console

5. **Test It**
   - Install a test userscript
   - Click the extension icon to open the editor

---

## ⚙️ Choosing Your Editor

1. Right-click the **Tampermonkey Editors** icon
2. Select **"Options"**
3. Choose your preferred editor:
   - **Web Editor (vscode.dev)** - Browser-based, no installation needed
   - **Desktop Editor (VS Code)** - Requires VS Code installed on your system
4. Click **"Save Settings"**
5. Extension will reload automatically

---

## 🛠️ Development

### Project Structure

```
tampermonkey-editors/
├── src/
│   ├── background/        # Background service worker
│   ├── options/          # Options page (NEW)
│   ├── tab/              # Content and page scripts
│   └── shared/           # Shared utilities
├── build_sys/            # Build configuration
├── scripts/              # Development scripts (NEW)
│   └── dev-setup.sh     # Automated setup script
├── release/              # Built extensions (generated)
└── other/                # Test dependencies
```

### Build Scripts

```bash
# Development build with watch mode
npm run build:watch

# Full release build
npm run all

# Run linter
npm run lint

# Create packages
npm run package
```

### Testing Changes

After making code changes:

```bash
# Rebuild
./build_sys/mkrelease.sh -v 999

# Reload extension in browser
# Chrome: Go to chrome://extensions/ and click the reload icon
# Firefox: Go to about:debugging and click "Reload"
```

---

## 📚 Documentation

- **[DESKTOP_VSCODE_SUPPORT.md](./DESKTOP_VSCODE_SUPPORT.md)** - Detailed implementation docs for desktop editor support
- **[Original README](./README.md)** - This file

---

## 🤝 Contributing

This is a fork of the original [Tampermonkey/tampermonkey-editors](https://github.com/Tampermonkey/tampermonkey-editors) with added desktop VS Code support.

### Making Changes

1. Make your changes in the `src/` directory
2. Test using the quick start guide above
3. Commit and push to your fork
4. Consider submitting a PR to the upstream repository

---

## 📝 License

© Jan Biniok - See LICENSE file for details

---

## 🔗 Links

- **Upstream Repository**: [Tampermonkey/tampermonkey-editors](https://github.com/Tampermonkey/tampermonkey-editors)
- **This Fork**: [tobiashochguertel/tampermonkey-editors](https://github.com/tobiashochguertel/tampermonkey-editors)
- **Tampermonkey**: [tampermonkey.net](https://www.tampermonkey.net/)
- **VS Code**: [code.visualstudio.com](https://code.visualstudio.com/)
---

## 📋 What's Automated vs Manual

### Original README (Manual Process)

The original instructions required:
1. ❌ Manual: Run `mkrelease.sh` build script
2. ❌ Manual: Download Tampermonkey CRX with wget
3. ❌ Manual: Extract with unzip
4. ❌ Manual: Run sed command to modify background.js
5. ❌ Manual: Load extensions in browser
6. ❌ Manual: Find and copy extension ID
7. ❌ Manual: Open console and paste config code
8. ❌ Manual: Test and hope nothing broke

### Our Automated Scripts

#### What We Automated ✅

**Build Scripts:**
- ✅ `./scripts/quick-build.sh` - Builds Chrome + Firefox properly
- ✅ `./scripts/simple-build.sh` - Alternative build (same as quick)
- ✅ `./scripts/dev-setup.sh` - Full setup including Tampermonkey download

**Validation:**
- ✅ `./scripts/validate-build.sh` - Checks for CSP violations, wrong APIs
- ✅ Detects Firefox code in Chrome build
- ✅ Detects Chrome code in Firefox build
- ✅ Validates file sizes (bloat detection)
- ✅ Checks manifest structure

**Configuration:**
- ✅ `./scripts/configure-tampermonkey.sh` - Interactive config generator
- ✅ Downloads Tampermonkey CRX automatically
- ✅ Extracts and modifies background.js
- ✅ Generates config code with your extension ID
- ✅ Saves to file for easy pasting

#### What Requires Browser Interaction ⚠️

These **cannot** be automated (browser security restrictions):
- ⚠️ Loading extensions via chrome://extensions/
- ⚠️ Copying the auto-generated extension ID
- ⚠️ Opening DevTools console
- ⚠️ Pasting config code

But we **guide you through** these steps with clear instructions!

---

## 🔍 Validation System

Our validation catches issues that the original setup would miss:

```bash
./scripts/validate-build.sh
```

**What it checks:**
- ✅ No `createElement` in Chrome (CSP violation)
- ✅ No `textContent` in Chrome (CSP violation)
- ✅ No Firefox API in Chrome build (`browser.*`)
- ✅ No Chrome API in Firefox build (`webNavigation`)
- ✅ Correct manifest structure
- ✅ File size validation (detects code bloat)
- ✅ Required patterns present

**Example output:**
```
🔍 Tampermonkey Editors - Build Validation
==========================================

🔍 Validating Chrome build...
  📄 Checking content.js...
  ✅ content.js is clean (1382 bytes)
  📄 Checking background.js...
  ✅ background.js is correct
  
✅ Chrome build: VALID
✅ Firefox build: VALID

✅ All checks passed!
```

---

## 🛠️ Development Workflow

### For Developers

```bash
# 1. Make changes to source code
vim src/background/index.ts

# 2. Build
./scripts/quick-build.sh

# 3. Validate
./scripts/validate-build.sh

# 4. If validation fails, check errors and rebuild
# If validation passes, reload extension in browser
```

### For Testing

```bash
# Full test setup
./scripts/dev-setup.sh

# Configure connection
./scripts/configure-tampermonkey.sh

# Load in browser and test!
```

### For Quick Iterations

```bash
# Build + validate in one command
./scripts/quick-build.sh && ./scripts/validate-build.sh

# OR use npm
npm run validate
```

---

## 📚 Scripts Reference

| Script | Purpose | When to Use |
|--------|---------|-------------|
| `quick-build.sh` | Fast build of both extensions | After code changes |
| `simple-build.sh` | Same as quick-build | Alternative command |
| `dev-setup.sh` | Full setup with Tampermonkey | First time setup |
| `validate-build.sh` | Check build correctness | After every build |
| `configure-tampermonkey.sh` | Generate config code | After loading extensions |

All scripts are in the `scripts/` directory and executable.

